#!/bin/sh
# Usage: script/cibuild
# CI build script
#
set -e

# GC customizations
export RUBY_GC_MALLOC_LIMIT=79000000
export RUBY_HEAP_MIN_SLOTS=800000
export RUBY_HEAP_FREE_MIN=100000
export RUBY_HEAP_SLOTS_INCREMENT=400000
export RUBY_HEAP_SLOTS_GROWTH_FACTOR=1
export PATH="/usr/share/rbenv/shims:$PATH"
export RACK_ROOT=$(cd "$(dirname $0)"/.. && pwd)
export RACK_ENV="test"
export RAILS_ENV="test"
# TODO: need newer 2.2.x ruby for nanoc
# export RBENV_VERSION="2.2.2"

# clean out the ruby environment
export RUBYLIB=
export RUBYOPT=

# bootstrap gem environment changes
cd "$RACK_ROOT"
echo 'Bootstrapping gems...'
# script/bootstrap

echo "==> Running testsâ€¦"

bundle exec rake spec rubocop
